podTemplate(
  containers: [
    containerTemplate(name: 'maven', image: 'maven:3.8-jdk-11', command: 'sleep', args: '99d'),
    containerTemplate(name: 'docker', image: 'docker',  command: 'sleep', args: '99d'),
    containerTemplate(name: 'kube', image: 'bitnami/kubectl',  command: 'sleep', args: '99d')
  ],
  volumes: [
    hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')
  ]) {
    node(POD_LABEL) {
        stage("CI/CD pipeline") {
	        container('maven') {
	            stage("Checkout") {
                    git branch: "master", url: "https://github.com/masalinas/poc-simple-java.git"
                }

	            stage('Compile') {
                    sh "mvn clean install -DskipTests"
                }

                 stage("Checkstyle") {
                    sh "mvn checkstyle:checkstyle"
                 }

                stage("Run unit tests") {
                    sh "mvn test -Punit"

                    junit "**/TEST-*.xml"
                }

                stage("Run integration tests") {
                    sh "mvn test -Pintegration"
                }
	        }

	        container('docker') {
                stage("Compile and push image") {
                   sh "docker build -t $DOCKER_REGISTRY:$BUILD_NUMBER ."

                   sh "docker login --username=$DOCKER_USER --password=$DOCKER_PASS"

                   sh "docker image push $DOCKER_REGISTRY:$BUILD_NUMBER"
                }
            }

            stage("Deploy image") {
                steps {
                    sh 'cat deployment-template.yaml | sed "s|{{DOCKER_IMAGE}}|masalinasgancedo/poc-simple-java:$BUILD_NUMBER|" > deployment.yaml'

                    withCredentials([kubeconfigFile(credentialsId: 'kube-config', variable: 'KUBECONFIG')]) {
                        sh 'curl -LO "https://storage.googleapis.com/kubernetes-release/release/v1.22.1/bin/linux/amd64/kubectl"'
                        sh 'chmod u+x ./kubectl'

                        sh './kubectl --kubeconfig=${KUBECONFIG} apply -f deployment.yaml'
                    }
                }
            }
        }
    }
}
